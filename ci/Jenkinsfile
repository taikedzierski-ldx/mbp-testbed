prepared_node_tests = [:]

def prepare_all_nodes_for_test(agent_label) {
    def nodelist = nodesByLabel(label: "${agent_label}")

    for (agentName in nodelist) {
        println "Preparing task for " + agentName

        prepared_node_tests[ "${agentName}" ] = {
            build job: '/System/Instrument/Development_and_tests/Tai dev stuff/Single_build_job',
            parameters: [
                string(name: 'TEST_AGENT_LABEL', value: "${agentName}"),
            ]
        }
    }
}


pipeline {
    agent { label "_runner:linux" }

    stages {
        stage('Kick-off agents') {
            steps {
                script {
                    prepare_all_nodes_for_test("_ldx2_")
                    parallel prepared_node_tests
                }
            }
        }
    }
}

